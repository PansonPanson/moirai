æ‰€è°“æœåŠ¡å‘ç°æ˜¯æŒ‡æŠŠå®¢æˆ·ç«¯å®ä¾‹ä¿¡æ¯æ³¨å†Œåˆ°æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹è¿™å‡ ä¸ªç±»ï¼š
+ `DiscoveryClient`
+ `InstanceInfo`
+ `HttpAgent`
+ `InstanceInfoProviderFactory`
+ `DiscoveryConfiguration` 




---

#  1. DiscoveryClient ç±»å›¾ï¼ˆClass Diagramï¼‰

```
+-------------------------------------+
|            DiscoveryClient          |
|-------------------------------------|
| - httpAgent: HttpAgent               |
| - instanceInfo: InstanceInfo         |
| - lastSuccessfulHeartbeatTimestamp: long |
| - appPathIdentifier: String          |
|-------------------------------------|
| + DiscoveryClient(HttpAgent, InstanceInfo) |
| + register(): boolean                |
| + destroy(): void (ç»§æ‰¿è‡ª DisposableBean) |
+-------------------------------------+

                  |
                  | ä¾èµ–
                  v
+-------------------------------------+
|              HttpAgent              |
|-------------------------------------|
| + httpPostByDiscovery(path, data): Result |
+-------------------------------------+

                  |
                  | èšåˆ
                  v
+-------------------------------------+
|             InstanceInfo            |
|-------------------------------------|
| + instanceId: String                |
| + appName: String                   |
| + hostName: String                  |
| + port: String                      |
| + clientBasePath: String            |
| + callBackUrl: String               |
| + identify: String                  |
| + active: String                    |
| + groupKey: String                  |
| ...ï¼ˆè¿˜æœ‰å…¶ä»–å±æ€§ï¼‰              |
+-------------------------------------+
```

### è¯´æ˜ï¼š

- **DiscoveryClient**
    - èšåˆäº†ä¸€ä¸ª `InstanceInfo`ï¼ˆå®¢æˆ·ç«¯è‡ªå·±çš„ä¿¡æ¯ï¼‰
    - æŒæœ‰ä¸€ä¸ª `HttpAgent`ï¼ˆè´Ÿè´£ HTTP é€šä¿¡ï¼‰
    - ç»§æ‰¿äº† `DisposableBean`ï¼Œæ”¯æŒåº”ç”¨é”€æ¯æ—¶æ‰§è¡Œæ³¨é”€ã€‚

- **HttpAgent**
    - å°è£…äº† `POST` è¯·æ±‚ï¼Œç”¨äºæ³¨å†Œåˆ°æœåŠ¡ç«¯ã€‚

- **InstanceInfo**
    - ä¿å­˜äº†å®¢æˆ·ç«¯æ‰€æœ‰çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ IPã€ç«¯å£ã€åº”ç”¨åç­‰ã€‚

---

# 2. æ³¨å†Œæµç¨‹è¯¦ç»†å›¾


```
[Spring Boot å¯åŠ¨é˜¶æ®µ]
        |
        v
DiscoveryConfiguration
        |
        | åˆ›å»º InstanceInfo (instanceConfig())
        v
InstanceInfoProviderFactory
        |
        | ç”Ÿæˆ InstanceInfo å¯¹è±¡ï¼ˆå¸¦ IP/ç«¯å£/å›è°ƒåœ°å€ï¼‰
        v
DiscoveryConfiguration
        |
        | åˆ›å»º DiscoveryClient (hippo4JDiscoveryClient())
        v
DiscoveryClient
        |
        | -> æ„é€ å™¨å†…éƒ¨æ‰§è¡Œ register()
        v
register()
        |
        | 1. ç»„è£… URL: BASE_PATH + "/apps/register/"
        | 2. è°ƒç”¨ httpAgent.httpPostByDiscovery(urlPath, instanceInfo)
        |
        v
HttpAgent
        |
        | HTTP POST è¯·æ±‚å‘åˆ°æœåŠ¡ç«¯
        v
[æœåŠ¡ç«¯æ¥å£ï¼š/apps/register/]
        |
        | ä¿å­˜å®¢æˆ·ç«¯ä¿¡æ¯åˆ°æ³¨å†Œè¡¨
        v
[è¿”å›æˆåŠŸ/å¤±è´¥ç»“æœ]
        |
        v
DiscoveryClient
        |
        | æ‰“æ—¥å¿—ï¼šæ³¨å†ŒæˆåŠŸ/å¤±è´¥
        v
[æ³¨å†Œç»“æŸ]
```

---

# ğŸ”¥ è¡¥å……æµç¨‹

```mermaid

DiscoveryConfiguration -> InstanceInfoProviderFactory : åˆ›å»º InstanceInfo
InstanceInfoProviderFactory -> InstanceInfo : å¡«å……å®¢æˆ·ç«¯ä¿¡æ¯
DiscoveryConfiguration -> DiscoveryClient : åˆ›å»º DiscoveryClient
DiscoveryClient -> DiscoveryClient : è°ƒç”¨ register()
DiscoveryClient -> HttpAgent : httpPostByDiscovery(url, instanceInfo)
HttpAgent -> æœåŠ¡ç«¯ : HTTP POST /apps/register/
æœåŠ¡ç«¯ -> HttpAgent : è¿”å›æ³¨å†Œç»“æœ
HttpAgent -> DiscoveryClient : è¿”å› Result
DiscoveryClient -> æ—¥å¿—ç³»ç»Ÿ : æ‰“å°æ³¨å†ŒæˆåŠŸ/å¤±è´¥æ—¥å¿—
```

---


# æœåŠ¡å®ä¾‹ç±»ï¼šInstanceInfo

```java
public class InstanceInfo {

    
    private static final String UNKNOWN = "unknown";

    /**
     * åº”ç”¨åç§°ï¼Œæœªè®¾ç½®å°±æ˜¯æœªçŸ¥
     */
    private String appName = UNKNOWN;

    /**
     * åœ°å€
     */
    private String hostName;

    
    /**
     * å‘½åç©ºé—´ + é¡¹ç›®Id
     */
    private String groupKey;

    /**
     * ç«¯å£å·
     */
    private String port;

    /**
     * å®¢æˆ·ç«¯æœåŠ¡å®ä¾‹Idï¼Œå…¶å®å°±æ˜¯å®¢æˆ·ç«¯åœ°å€ + uuid
     */
    private String instanceId;

    
    private String ipApplicationName;

    /**
     * å®¢æˆ·ç«¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸Šä¸‹æ–‡è·¯å¾„
     */
    private String clientBasePath;

    /**
     * å®¢æˆ·ç«¯å›è°ƒåœ°å€
     */
    private String callBackUrl;

    /**
     * å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå…¶å®å’ŒinstanceIdä¸€æ ·,
     * åªä¸è¿‡è¿™ä¸ªæ ‡è¯†ç¬¦æ˜¯è¦åœ¨webç•Œé¢å±•ç¤ºç»™ç”¨æˆ·çš„
     */
    private String identify;

    private String active;

    private volatile String vipAddress;

    private volatile String secureVipAddress;

    private volatile ActionType actionType;

    private volatile boolean isInstanceInfoDirty = false;

    /**
     * å®¢æˆ·ç«¯æœ€åæ›´æ–°æ—¶é—´æˆ³
     */
    private volatile Long lastUpdatedTimestamp;

    private volatile Long lastDirtyTimestamp;

    /**
     * æœåŠ¡å®ä¾‹çš„é»˜è®¤çŠ¶æ€ä¸ºupï¼Œä¹Ÿå°±æ˜¯ä¸Šçº¿çŠ¶æ€
     */
    private volatile InstanceStatus status = InstanceStatus.UP;

    private volatile InstanceStatus overriddenStatus = InstanceStatus.UNKNOWN;

    public InstanceInfo() {
        this.lastUpdatedTimestamp = System.currentTimeMillis();
        this.lastDirtyTimestamp = lastUpdatedTimestamp;
    }

    public void setLastUpdatedTimestamp() {
        this.lastUpdatedTimestamp = System.currentTimeMillis();
    }

    public Long getLastDirtyTimestamp() {
        return lastDirtyTimestamp;
    }

    public synchronized void setOverriddenStatus(InstanceStatus status) {
        if (this.overriddenStatus != status) {
            this.overriddenStatus = status;
        }
    }

    public InstanceStatus getStatus() {
        return status;
    }

    public synchronized void setIsDirty() {
        isInstanceInfoDirty = true;
        lastDirtyTimestamp = System.currentTimeMillis();
    }

    public synchronized long setIsDirtyWithTime() {
        setIsDirty();
        return lastDirtyTimestamp;
    }

    public synchronized void unsetIsDirty(long unsetDirtyTimestamp) {
        if (lastDirtyTimestamp <= unsetDirtyTimestamp) {
            isInstanceInfoDirty = false;
        }
    }

    public void setActionType(ActionType actionType) {
        this.actionType = actionType;
    }

    /**
     * Instance status.
     */
    public enum InstanceStatus {

        //å¥åº·çŠ¶æ€
        UP,

        //ä¸‹çº¿çŠ¶æ€
        DOWN,

        //å¯åŠ¨ä¸­çŠ¶æ€
        STARTING,

        //åœæ­¢æœåŠ¡çŠ¶æ€
        OUT_OF_SERVICE,

        //æœªçŸ¥çŠ¶æ€
        UNKNOWN;

        public static InstanceStatus toEnum(String s) {
            if (s != null) {
                try {
                    return InstanceStatus.valueOf(s.toUpperCase());
                } catch (IllegalArgumentException e) {
                    // ignore and fall through to unknown
                    log.debug("illegal argument supplied to InstanceStatus.valueOf: {}, defaulting to {}", s, UNKNOWN);
                }
            }
            return UNKNOWN;
        }
    }

    /**
     * Action type.
     */
    public enum ActionType {
        /**
         * ADDED
         */
        ADDED,

        /**
         * MODIFIED
         */
        MODIFIED,

        /**
         * DELETED
         */
        DELETED
    }

    /**
     * Instance renew.
     */
    @Data
    @Accessors(chain = true)
    public static class InstanceRenew {

        private String appName;

        private String instanceId;

        private String lastDirtyTimestamp;

        private String status;
    }
}
```



